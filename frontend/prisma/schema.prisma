generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Player {
  id              String    @id @default(uuid())
  walletAddress   String    @unique
  username        String    @unique
  avatarUrl       String?
  level           Int       @default(1)
  experience      Int       @default(0)
  respect         Int       @default(0)
  money           Float     @default(500)
  tokenBalance    Float     @default(0)
  health          Int       @default(100)
  maxHealth       Int       @default(100)
  stamina         Int       @default(100)
  maxStamina      Int       @default(100)
  tickets         Int       @default(200)
  addiction       Float     @default(0)
  profession      String    @default("GANGSTER")
  professionLevel Int       @default(1)
  professionXp    Int       @default(0)
  strength        Int       @default(10)
  defense         Int       @default(10)
  intelligence    Int       @default(10)
  charisma        Int       @default(10)
  agility         Int       @default(10)
  isInPrison      Boolean   @default(false)
  prisonUntil     DateTime?
  isInHospital    Boolean   @default(false)
  hospitalUntil   DateTime?
  lastRobberyAt   DateTime?
  lastAssaultAt   DateTime?
  lastDrugUseAt   DateTime?
  lastTrainingAt  DateTime?
  nonce           String?
  roundId         String?
  round           GameRound? @relation(fields: [roundId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime  @default(now())
  inventory       InventoryItem[]
  gangMembership  GangMember?
  sentAssaults    Assault[]       @relation("Attacker")
  receivedAssaults Assault[]      @relation("Defender")
  robberyAttempts RobberyAttempt[]
  universityEnrollments UniversityEnrollment[]
  drugInventory   DrugInventory[]
  marketListings  MarketListing[] @relation("Seller")
  marketPurchases MarketListing[] @relation("Buyer")
  tokenTransactions TokenTransaction[]
  casinoBets      CasinoBet[]
  stakingPosition StakingPosition?
  notifications   Notification[]
  prisonRecords   PrisonRecord[]
  hospitalVisits  HospitalVisit[]
  @@index([walletAddress])
  @@index([respect])
  @@index([level])
  @@index([roundId])
}

model GameRound {
  id             String    @id @default(uuid())
  roundNumber    Int       @unique
  startDate      DateTime
  endDate        DateTime
  gameDayLength  Int       @default(360)
  totalGameDays  Int       @default(156)
  currentGameDay Int       @default(1)
  isActive       Boolean   @default(true)
  tokenRewardPool Float    @default(0)
  players        Player[]
  rankings       RoundRanking[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model RoundRanking {
  id          String    @id @default(uuid())
  roundId     String
  round       GameRound @relation(fields: [roundId], references: [id])
  playerId    String
  rank        Int
  respect     Int
  tokenReward Float     @default(0)
  @@unique([roundId, playerId])
  @@index([roundId, rank])
}

model RobberyDefinition {
  id              String  @id @default(uuid())
  name            String  @unique
  description     String
  levelRequired   Int
  staminaCost     Int
  baseDifficulty  Float
  minRewardMoney  Float
  maxRewardMoney  Float
  minRewardRespect Int
  maxRewardRespect Int
  tokenReward     Float   @default(0)
  cooldownSeconds Int     @default(30)
  isGangRobbery   Boolean @default(false)
  minGangMembers  Int     @default(1)
  imageUrl        String?
  sortOrder       Int     @default(0)
  attempts        RobberyAttempt[]
}

model RobberyAttempt {
  id            String    @id @default(uuid())
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id])
  robberyId     String
  robbery       RobberyDefinition @relation(fields: [robberyId], references: [id])
  success       Boolean
  moneyEarned   Float     @default(0)
  respectEarned Int       @default(0)
  tokensEarned  Float     @default(0)
  wasCaught     Boolean   @default(false)
  gangId        String?
  createdAt     DateTime  @default(now())
  @@index([playerId, createdAt])
}

model DrugDefinition {
  id              String  @id @default(uuid())
  name            String  @unique
  description     String
  staminaRestore  Int
  addictionRate   Float
  buyPrice        Float
  sellPrice       Float
  ticketsRequired Int     @default(1)
  levelRequired   Int     @default(1)
  imageUrl        String?
  inventory       DrugInventory[]
  marketListings  MarketListing[]
}

model DrugInventory {
  id          String    @id @default(uuid())
  playerId    String
  player      Player    @relation(fields: [playerId], references: [id])
  drugId      String
  drug        DrugDefinition @relation(fields: [drugId], references: [id])
  quantity    Int       @default(0)
  @@unique([playerId, drugId])
}

model Assault {
  id              String    @id @default(uuid())
  attackerId      String
  attacker        Player    @relation("Attacker", fields: [attackerId], references: [id])
  defenderId      String
  defender        Player    @relation("Defender", fields: [defenderId], references: [id])
  attackerWon     Boolean
  damageDealt     Int
  moneyStolen     Float     @default(0)
  respectGained   Int       @default(0)
  respectLost     Int       @default(0)
  attackerCaught  Boolean   @default(false)
  weaponUsedId    String?
  createdAt       DateTime  @default(now())
  @@index([attackerId, createdAt])
  @@index([defenderId, createdAt])
}

model HospitalVisit {
  id               String    @id @default(uuid())
  playerId         String
  player           Player    @relation(fields: [playerId], references: [id])
  type             String
  cost             Float
  healthRestored   Int       @default(0)
  addictionReduced Float     @default(0)
  createdAt        DateTime  @default(now())
}

model SkillDefinition {
  id              String       @id @default(uuid())
  name            String       @unique
  description     String
  profession      String?
  levelRequired   Int          @default(1)
  cost            Float
  durationMinutes Int
  statBoosts      String
  prerequisiteId  String?
  prerequisite    SkillDefinition? @relation("SkillTree", fields: [prerequisiteId], references: [id])
  dependents      SkillDefinition[] @relation("SkillTree")
  enrollments     UniversityEnrollment[]
}

model UniversityEnrollment {
  id          String    @id @default(uuid())
  playerId    String
  player      Player    @relation(fields: [playerId], references: [id])
  skillId     String
  skill       SkillDefinition @relation(fields: [skillId], references: [id])
  startedAt   DateTime  @default(now())
  completesAt DateTime
  isCompleted Boolean   @default(false)
  @@unique([playerId, skillId])
}

model CasinoBet {
  id          String    @id @default(uuid())
  playerId    String
  player      Player    @relation(fields: [playerId], references: [id])
  gameType    String
  betAmount   Float
  payout      Float     @default(0)
  won         Boolean
  details     String?
  serverSeed  String
  clientSeed  String
  nonce       Int
  createdAt   DateTime  @default(now())
}

model Gang {
  id            String    @id @default(uuid())
  name          String    @unique
  tag           String    @unique
  description   String?
  leaderId      String
  level         Int       @default(1)
  respect       Int       @default(0)
  money         Float     @default(0)
  maxMembers    Int       @default(10)
  imageUrl      String?
  members       GangMember[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  @@index([respect])
}

model GangMember {
  id          String    @id @default(uuid())
  gangId      String
  gang        Gang      @relation(fields: [gangId], references: [id])
  playerId    String    @unique
  player      Player    @relation(fields: [playerId], references: [id])
  role        String    @default("MEMBER")
  joinedAt    DateTime  @default(now())
  @@index([gangId])
}

model PrisonRecord {
  id            String    @id @default(uuid())
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id])
  reason        String
  sentenceEnd   DateTime
  bribeCost     Float?
  escaped       Boolean   @default(false)
  escapedAt     DateTime?
  createdAt     DateTime  @default(now())
  @@index([playerId, createdAt])
}

model ItemDefinition {
  id            String    @id @default(uuid())
  name          String    @unique
  description   String
  type          String
  rarity        String    @default("COMMON")
  levelRequired Int       @default(1)
  price         Float
  tokenPrice    Float     @default(0)
  stats         String
  imageUrl      String?
  isTokenOnly   Boolean   @default(false)
  inventory     InventoryItem[]
  marketListings MarketListing[]
}

model InventoryItem {
  id          String    @id @default(uuid())
  playerId    String
  player      Player    @relation(fields: [playerId], references: [id])
  itemId      String
  item        ItemDefinition @relation(fields: [itemId], references: [id])
  quantity    Int       @default(1)
  isEquipped  Boolean   @default(false)
  durability  Int       @default(100)
  @@unique([playerId, itemId])
  @@index([playerId])
}

model MarketListing {
  id            String    @id @default(uuid())
  sellerId      String
  seller        Player    @relation("Seller", fields: [sellerId], references: [id])
  buyerId       String?
  buyer         Player?   @relation("Buyer", fields: [buyerId], references: [id])
  itemId        String?
  item          ItemDefinition? @relation(fields: [itemId], references: [id])
  drugId        String?
  drug          DrugDefinition? @relation(fields: [drugId], references: [id])
  quantity      Int       @default(1)
  pricePerUnit  Float
  status        String    @default("ACTIVE")
  txSignature   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  soldAt        DateTime?
  @@index([status, createdAt])
  @@index([sellerId])
}

model TokenTransaction {
  id            String    @id @default(uuid())
  playerId      String
  player        Player    @relation(fields: [playerId], references: [id])
  type          String
  amount        Float
  description   String
  txSignature   String?   @unique
  status        String    @default("PENDING")
  createdAt     DateTime  @default(now())
  @@index([playerId, createdAt])
  @@index([txSignature])
}

model StakingPosition {
  id            String    @id @default(uuid())
  playerId      String    @unique
  player        Player    @relation(fields: [playerId], references: [id])
  amountStaked  Float     @default(0)
  stakedAt      DateTime?
  lastClaimAt   DateTime?
  tier          String    @default("NONE")
  @@index([tier])
}

model Notification {
  id          String    @id @default(uuid())
  playerId    String
  player      Player    @relation(fields: [playerId], references: [id])
  type        String
  title       String
  message     String
  data        String?
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  @@index([playerId, isRead, createdAt])
}
